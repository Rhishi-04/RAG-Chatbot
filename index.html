<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI RAG Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1e40af',
            secondary: '#059669',
            accent: '#dc2626'
          }
        }
      }
    }
  </script>
  <style>
    .chat-container {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    .chat-container::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    .chat-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    .message-bubble {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .typing-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">AI RAG Chatbot</h1>
      <p class="text-gray-600 text-lg">Ask questions about your documents with AI-powered retrieval</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Panel - Document Upload -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-lg p-6 sticky top-8">
          <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            Document Upload
          </h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Session ID</label>
              <input type="text" id="sessionIdInput" value="default" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Upload Documents</label>
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors">
                <input type="file" id="fileInput" accept=".pdf,.txt" multiple 
                       class="hidden" />
                <label for="fileInput" class="cursor-pointer">
                  <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <p class="text-sm text-gray-600 mb-2">
                    <span class="font-medium text-primary hover:text-primary-dark">Click to upload</span> or drag and drop
                  </p>
                  <p class="text-xs text-gray-500">PDF, TXT files up to 10MB</p>
                </label>
              </div>
            </div>
            
            <button id="uploadBtn" 
                    class="w-full bg-secondary text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <span class="flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Upload Documents
              </span>
            </button>
            
            <button id="clearSessionBtn" 
                    class="w-full bg-accent text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <span class="flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Clear Session
              </span>
            </button>
            
            <div id="uploadMessage" class="text-sm"></div>
            
            <div id="uploadedFiles" class="space-y-2"></div>
          </div>
        </div>
      </div>

      <!-- Right Panel - Chat Interface -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <!-- Chat Header -->
          <div class="bg-primary text-white px-6 py-4">
            <h3 class="text-lg font-semibold flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
              AI Assistant
            </h3>
            <p class="text-blue-100 text-sm">Ask questions about your documents</p>
          </div>

          <!-- Chat Messages -->
          <div id="chat" class="chat-container h-96 overflow-y-auto p-6 bg-gray-50">
            <div class="text-center text-gray-500 py-8">
              <svg class="mx-auto h-12 w-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p class="text-lg font-medium">Welcome to AI Assistant</p>
              <p class="text-sm">Upload your documents and start asking questions.</p>
            </div>
          </div>

          <!-- Input Area -->
          <div class="p-6 bg-white border-t border-gray-200">
            <div class="flex space-x-3">
              <div class="flex-1">
                <textarea id="questionInput" rows="3" 
                          placeholder="Ask a question about your documents..."
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none"></textarea>
              </div>
              <button id="askBtn" 
                      class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed self-end">
                <span class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                  </svg>
                  Ask
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8000";
    const chatEl = document.getElementById("chat");
    const questionInput = document.getElementById("questionInput");
    const askBtn = document.getElementById("askBtn");
    const sessionIdInput = document.getElementById("sessionIdInput");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const clearSessionBtn = document.getElementById("clearSessionBtn");
    const uploadMessageEl = document.getElementById("uploadMessage");
    const uploadedFilesEl = document.getElementById("uploadedFiles");

    let chatHistory = [];
    let uploadedFiles = [];

    function appendMessage(role, content, confidence, timestamp) {
      if (chatHistory.length === 0) {
        chatEl.innerHTML = '';
      }
      
      chatHistory.push({ role, content, confidence, timestamp });

      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message-bubble", "mb-4", "max-w-4xl");
      
      if (role === "user") {
        msgDiv.classList.add("ml-auto");
        msgDiv.innerHTML = `
          <div class="bg-primary text-white rounded-lg rounded-br-none px-4 py-3 inline-block">
            <div class="font-medium mb-1">You</div>
            <div class="whitespace-pre-wrap">${content}</div>
          </div>
        `;
      } else {
        msgDiv.classList.add("mr-auto");
        msgDiv.innerHTML = `
          <div class="bg-white border border-gray-200 rounded-lg rounded-bl-none px-4 py-3 inline-block shadow-sm">
            <div class="font-medium text-gray-800 mb-1">AI Assistant</div>
            <div class="text-gray-700 whitespace-pre-wrap">${content}</div>
            ${confidence !== undefined && timestamp !== undefined ? `
              <div class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100">
                Confidence: ${(confidence * 100).toFixed(1)}% | ${new Date(timestamp).toLocaleString()}
              </div>
            ` : ''}
          </div>
        `;
      }

      chatEl.appendChild(msgDiv);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function showTypingIndicator() {
      const typingDiv = document.createElement("div");
      typingDiv.id = "typing-indicator";
      typingDiv.classList.add("message-bubble", "mb-4", "mr-auto", "max-w-4xl");
      typingDiv.innerHTML = `
        <div class="bg-white border border-gray-200 rounded-lg rounded-bl-none px-4 py-3 inline-block shadow-sm">
          <div class="font-medium text-gray-800 mb-2">AI Assistant</div>
          <div class="typing-indicator"></div>
        </div>
      `;
      chatEl.appendChild(typingDiv);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById("typing-indicator");
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    async function askQuestion() {
      const question = questionInput.value.trim();
      if (!question) return;

      askBtn.disabled = true;
      askBtn.innerHTML = `
        <span class="flex items-center">
          <div class="typing-indicator w-4 h-4 mr-2"></div>
          Thinking...
        </span>
      `;
      
      const session_id = sessionIdInput.value.trim() || "default";
      
      // Show typing indicator
      showTypingIndicator();
      
      try {
        const res = await fetch(`${API_BASE}/api/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, session_id }),
        });
        
        if (!res.ok) throw new Error(`Server error: ${res.status}`);

        const data = await res.json();
        
        // Hide typing indicator
        hideTypingIndicator();
        
        appendMessage("user", question);
        appendMessage("assistant", data.answer, data.confidence, data.timestamp);
        questionInput.value = "";
      } catch (err) {
        hideTypingIndicator();
        alert("Error: " + err.message);
      } finally {
        askBtn.disabled = false;
        askBtn.innerHTML = `
          <span class="flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            Ask
          </span>
        `;
      }
    }

    function updateUploadedFilesList() {
      uploadedFilesEl.innerHTML = uploadedFiles.map(file => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
          <div class="flex items-center">
            <svg class="w-4 h-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="text-sm text-gray-700">${file.name}</span>
          </div>
          <button onclick="removeFile('${file.name}')" class="text-red-500 hover:text-red-700">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `).join('');
    }

    function removeFile(fileName) {
      uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
      updateUploadedFilesList();
    }

    // Event Listeners
    askBtn.addEventListener("click", askQuestion);

    questionInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        askQuestion();
      }
    });

    clearSessionBtn.addEventListener("click", async () => {
      const session_id = sessionIdInput.value.trim() || "default";
      clearSessionBtn.disabled = true;
      clearSessionBtn.innerHTML = '<span class="flex items-center justify-center"><div class="typing-indicator w-4 h-4 mr-2"></div>Clearing...</span>';
      
      try {
        const res = await fetch(`${API_BASE}/clear-session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id }),
        });
        
        if (!res.ok) throw new Error("Failed to clear session");
        
        uploadMessageEl.innerHTML = '<span class="text-green-600">Session cleared successfully! Upload new documents to start fresh.</span>';
        
        // Clear chat history
        chatHistory = [];
        chatEl.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <svg class="mx-auto h-12 w-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-lg font-medium">Welcome to AI Assistant</p>
            <p class="text-sm">Upload your documents and start asking questions.</p>
          </div>
        `;
      } catch (err) {
        uploadMessageEl.innerHTML = `<span class="text-red-600">Clear session error: ${err.message}</span>`;
      } finally {
        clearSessionBtn.disabled = false;
        clearSessionBtn.innerHTML = `
          <span class="flex items-center justify-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Clear Session
          </span>
        `;
      }
    });

    fileInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files);
      uploadedFiles = [...uploadedFiles, ...files];
      updateUploadedFilesList();
    });

    uploadBtn.addEventListener("click", async () => {
      if (uploadedFiles.length === 0) {
        alert("Please select files to upload.");
        return;
      }

      uploadBtn.disabled = true;
      uploadMessageEl.innerHTML = '<span class="text-blue-600">Uploading...</span>';

      const session_id = sessionIdInput.value.trim() || "default";

      try {
        for (const file of uploadedFiles) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("session_id", session_id);

          const res = await fetch(`${API_BASE}/upload-doc`, {
            method: "POST",
            body: formData,
          });
          
          if (!res.ok) throw new Error(`Upload failed for ${file.name}`);
          
          const result = await res.json();
          uploadMessageEl.innerHTML = `<span class="text-green-600">${result.message} (Session: ${result.session_id}, Total: ${result.documents_in_session})</span>`;
        }

        uploadMessageEl.innerHTML = '<span class="text-green-600">All files uploaded and indexed successfully for this session!</span>';
        uploadedFiles = [];
        updateUploadedFilesList();
        fileInput.value = "";
      } catch (err) {
        uploadMessageEl.innerHTML = `<span class="text-red-600">Upload error: ${err.message}</span>`;
      } finally {
        uploadBtn.disabled = false;
      }
    });

    // Drag and drop functionality
    const dropZone = document.querySelector('.border-dashed');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      dropZone.classList.add('border-primary', 'bg-blue-50');
    }

    function unhighlight(e) {
      dropZone.classList.remove('border-primary', 'bg-blue-50');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      const newFiles = Array.from(files);
      uploadedFiles = [...uploadedFiles, ...newFiles];
      updateUploadedFilesList();
    }
  </script>
</body>
</html>
